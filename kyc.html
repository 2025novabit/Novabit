<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>KYC | Novabit</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="countries.js"></script>

<style>
/* ⚠️ CSS دقیقاً همان کد خودت است – دست نخورده */
body {
  margin:0;
  font-family: Roboto,sans-serif;
  background:#f4f6fa;
}
</style>
</head>

<body onload="loadKYC();">

<header>
  <h2>KYC Verification</h2>
  <button onclick="togglePanel()">Menu</button>
</header>

<div id="sidePanel">
  <button onclick="togglePanel()">Close</button>
  <a href="dashboard.html">dashboard</a>
  <a href="profile.html">Profile</a>
</div>

<div class="container">
  <div class="form-card">
    <h2>KYC Form</h2>

    <input id="firstName" placeholder="First Name">
    <input id="lastName" placeholder="Last Name">
    <input type="date" id="dob">

    <select id="countrySelect">
      <option value="">Select Country</option>
    </select>

    <label><input type="radio" name="docType" value="Passport" checked> Passport</label>
    <label><input type="radio" name="docType" value="ID Card"> ID Card</label>

    <input id="docNumber" placeholder="Document Number">

    <button onclick="saveKYC()">Submit KYC</button>

    <div id="kycStatus">Status: Pending</div>
  </div>
</div>

<!-- ✅ Supabase بدون module -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<script>
/* ✅ Supabase client */
const supabase = supabaseJs.createClient(
  "https://iecnioogmafgxwarmkxz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImllY25pb29nbWFmZ3h3YXJta3h6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3OTYwNDgsImV4cCI6MjA4MzM3MjA0OH0.3zkHQpwdYUVdf6_GkPfkLRu7xgWMaUHNuFmYMBgBsJA"
);

/* ---------- UI ---------- */
function togglePanel(){
  document.getElementById('sidePanel').classList.toggle('active');
}

function populateCountries(){
  const s = document.getElementById('countrySelect');
  countries.forEach(c=>{
    let o = document.createElement('option');
    o.value = c.name;
    o.textContent = c.name;
    s.appendChild(o);
  });
}

/* ---------- LOAD ---------- */
async function loadKYC(){
  populateCountries();

  const { data:{session} } = await supabase.auth.getSession();
  if(!session) return;

  const { data } = await supabase
    .from('kyc_requests')
    .select('*')
    .eq('user_id', session.user.id)
    .single();

  if(data){
    firstName.value = data.first_name || '';
    lastName.value = data.last_name || '';
    dob.value = data.dob || '';
    countrySelect.value = data.country || '';
    docNumber.value = data.doc_number || '';
    kycStatus.textContent = "Status: " + data.status;
  }
}

/* ---------- SAVE ---------- */
async function saveKYC(){
  const { data:{session} } = await supabase.auth.getSession();
  if(!session){ alert("Not logged in"); return; }

  const payload = {
    user_id: session.user.id,
    first_name: firstName.value,
    last_name: lastName.value,
    dob: dob.value,
    country: countrySelect.value,
    doc_type: document.querySelector('input[name="docType"]:checked').value,
    doc_number: docNumber.value,
    status: "Pending"
  };

  const { error } = await supabase
    .from('kyc_requests')
    .upsert(payload, { onConflict: 'user_id' });

  if(error){
    console.error(error);
    alert("Error saving KYC");
    return;
  }

  kycStatus.textContent = "Status: Pending";
  alert("KYC submitted");
}
</script>

</body>
</html>
