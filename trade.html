<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Trade | Novabit</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
<style>
body { font-family:'Roboto',sans-serif; margin:0; background:#f8f9fa; padding-bottom:60px; }
header { background:#1a1a2e; color:#fff; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:10; }
header h1 { margin:0; font-size:20px; }
#menuBtn { background:#4b49ac; color:#fff; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; }
#sideMenu { position:fixed; top:0; right:-300px; width:280px; height:100%; background:#fff; box-shadow:-2px 0 6px rgba(0,0,0,0.2); transition:right .3s; z-index:100; padding:20px; }
#sideMenu.active { right:0; }
#closeMenu { background:#e74c3c; color:#fff; border:none; padding:8px 12px; cursor:pointer; border-radius:5px; margin-bottom:15px; }
.container{ padding:20px; }
.card { background:#fff; padding:25px; border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,0.1); margin-bottom:20px; }
.input-group { margin-bottom:15px; }
.input-group label { display:block; margin-bottom:5px; font-weight:500; }
.input-group input, .input-group select { width:100%; padding:10px; border:1px solid #ccc; border-radius:5px; }
button { padding:10px 20px; background:#4b49ac; color:#fff; border:none; border-radius:5px; cursor:pointer; }
button:hover { background:#3a3690; }
.table-container { max-height:200px; overflow-y:auto; margin-top:20px; }
table { width:100%; border-collapse:collapse; }
th,td { padding:10px; text-align:left; }
th { background:#1a1a2e; color:#fff; }
tr:nth-child(even){ background:#f1f1f1; }
.bottom-nav { position:fixed; bottom:0; width:100%; background:#1a1a2e; display:flex; justify-content:space-around; padding:10px 0; }
.bottom-nav a { color:#fff; text-decoration:none; font-size:14px; }
.bottom-nav a.active { color:#4b49ac; }
</style>
</head>
<body>

<header>
  <h1>Trade</h1>
  <button id="menuBtn">Menu</button>
</header>

<div id="sideMenu">
  <button id="closeMenu">Close</button>
  <h3>Menu</h3>
  <a href="profile.html">Profile</a><br><br>
  <a href="wallet.html">Wallet</a><br><br>
  <a href="market.html">Market</a>
</div>

<div class="container">

<div class="card">
  <h2>Wallet Balances</h2>
  <div id="walletBalances">Loading...</div>
</div>

<div class="card">
  <h2>Trade Spot</h2>

  <div class="input-group">
    <label>From Coin</label>
    <select id="coinFrom"></select>
  </div>

  <div class="input-group">
    <label>To Coin</label>
    <select id="coinTo"></select>
  </div>

  <div class="input-group">
    <label>Amount</label>
    <input type="number" id="amount" placeholder="0.0000">
  </div>

  <div class="input-group">
    <label>Converted Amount</label>
    <div id="convertedAmount">-</div>
  </div>

  <button id="tradeBtn">Trade</button>
</div>

<div class="card">
  <h2>Trade History</h2>
  <div class="table-container">
    <table>
      <thead>
        <tr><th>Date</th><th>From</th><th>To</th><th>Amount</th><th>Converted</th></tr>
      </thead>
      <tbody id="tradeHistory">
        <tr><td colspan="5">No trades yet</td></tr>
      </tbody>
    </table>
  </div>
</div>

</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabase = createClient(
  "https://iecnioogmafgxwarmkxz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImllY25pb29nbWFmZ3h3YXJta3h6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3OTYwNDgsImV4cCI6MjA4MzM3MjA0OH0.3zkHQpwdYUVdf6_GkPfkLRu7xgWMaUHNuFmYMBgBsJA"
);

let user;
let wallets = {};
let marketCoins = [];

/* ========== MENU ========== */
const sideMenu = document.getElementById("sideMenu");
document.getElementById("menuBtn").onclick = ()=>sideMenu.classList.toggle("active");
document.getElementById("closeMenu").onclick = ()=>sideMenu.classList.remove("active");

/* ========== INIT ========== */
async function init(){
  const { data:{ session } } = await supabase.auth.getSession();
  if(!session){ alert("Login required"); return; }
  user = session.user;

  await loadMarketCoins();
  await loadWallets();
  await insertTradeHistory(from, to, amount, fromCoin.current_price);
  await loadTradeHistory();
}
window.onload = init;

/* ========== LOAD MARKET COINS (100) ========== */
async function loadMarketCoins(){
  const res = await fetch("https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1");
  marketCoins = await res.json();
}

/* ========== LOAD WALLET ========== */
async function loadWallets(){
  const { data } = await supabase.from('wallets').select('*').eq('user_id', user.id);
  wallets = {};
  if(data){
    data.forEach(w=>{
      if(Number(w.balance)>0) wallets[w.coin_symbol.toUpperCase()] = Number(w.balance);
    });
  }
  renderWallet();
  populateSelects();
}

/* ========== RENDER WALLET ========== */
function renderWallet(){
  let html='<ul>';
  if(Object.keys(wallets).length===0){ html+='<li>No balance</li>'; }
  else{
    Object.keys(wallets).forEach(c=>{
      html+=`<li>${c}: ${wallets[c]}</li>`;
    });
  }
  html+='</ul>';
  document.getElementById('walletBalances').innerHTML=html;
}

/* ========== POPULATE SELECTS ========== */
function populateSelects(){
  const from = document.getElementById('coinFrom');
  const to = document.getElementById('coinTo');
  from.innerHTML=''; to.innerHTML='';

  // From: فقط ارزهایی که موجودی دارند
  Object.keys(wallets).forEach(c=>{
    from.innerHTML+=`<option value="${c}">${c}</option>`;
  });

  // To: همه ارزهای بازار
  marketCoins.forEach(c=>{
    to.innerHTML+=`<option value="${c.symbol.toUpperCase()}">${c.symbol.toUpperCase()} - $${c.current_price}</option>`;
  });

  updateConverted();
}

/* ========== UPDATE CONVERTED ========== */
function updateConverted(){
  const amount = Number(document.getElementById('amount').value);
  const from = document.getElementById('coinFrom').value;
  const to = document.getElementById('coinTo').value;
  if(!amount || !from || !to){ document.getElementById('convertedAmount').innerText='-'; return; }

  const fromCoin = marketCoins.find(c=>c.symbol.toUpperCase()===from);
  const toCoin = marketCoins.find(c=>c.symbol.toUpperCase()===to);
  if(!fromCoin || !toCoin) return;

  const converted = (amount * fromCoin.current_price)/toCoin.current_price;
  document.getElementById('convertedAmount').innerText = converted.toFixed(6);
}
document.getElementById('amount').addEventListener('input', updateConverted);
document.getElementById('coinFrom').addEventListener('change', updateConverted);
document.getElementById('coinTo').addEventListener('change', updateConverted);

/* ========== TRADE ========== */
document.getElementById("tradeBtn").onclick = async function(){
  const amount = Number(document.getElementById('amount').value);
  const from = document.getElementById('coinFrom').value;
  const to = document.getElementById('coinTo').value;

  if(!amount || amount<=0) return alert("Invalid amount");
  if(!wallets[from] || wallets[from] < amount) return alert("Insufficient balance");

  const fromCoin = marketCoins.find(c=>c.symbol.toUpperCase()===from);
  const toCoin = marketCoins.find(c=>c.symbol.toUpperCase()===to);
  const converted = (amount*fromCoin.current_price)/toCoin.current_price;

  // UPDATE FROM WALLET
  const { error: eFrom } = await supabase.from('wallets')
    .update({balance: wallets[from]-amount})
    .eq('user_id', user.id)
    .eq('coin_symbol', from);
  if(eFrom){ console.error(eFrom); return alert("Wallet FROM update failed"); }

  // UPDATE TO WALLET
  const { data: existingTo } = await supabase.from('wallets')
    .select('*')
    .eq('user_id', user.id)
    .eq('coin_symbol', to);

  if(existingTo.length>0){
    await supabase.from('wallets')
      .update({balance: existingTo[0].balance + converted})
      .eq('user_id', user.id)
      .eq('coin_symbol', to);
  } else {
    await supabase.from('wallets').insert({user_id:user.id, coin_symbol:to, balance:converted});
  }

/* ========== INSERT TRADE HISTORY ========== */
async function insertTradeHistory(from, to, amount, priceUsd){
  const { error } = await supabase
    .from('trade_history')
    .insert({
      user_id: user.id,
      trade_type: 'spot',
      coin_symbol: from + '->' + to, // نمایش از -> به
      amount: amount,
      price_usd: priceUsd,
      created_at: new Date()
    });
  if(error) console.error("Trade history insert error:", error);
}

/* ========== LOAD TRADE HISTORY ========== */
async function loadTradeHistory(){
  const { data, error } = await supabase
    .from('trade_history')
    .select('*')
    .eq('user_id', user.id)
    .order('created_at', { ascending: false });

  if(error){ console.error("Load trade history error:", error); return; }

  const tbody = document.getElementById('tradeHistory');
  tbody.innerHTML = '';

  if(!data || data.length===0){
    tbody.innerHTML = '<tr><td colspan="5">No trades yet</td></tr>';
    return;
  }

  data.forEach(t=>{
    // برای هر ردیف، مقدار تبدیل تقریبی را با توجه به قیمت لحظه‌ای To Coin محاسبه می‌کنیم
    const coins = t.coin_symbol.split('->');
    const fromCoin = coins[0];
    const toCoin = coins[1];

    const toMarket = marketCoins.find(c=>c.symbol.toUpperCase()===toCoin);
    const converted = toMarket ? ((t.amount*t.price_usd)/toMarket.current_price).toFixed(6) : '-';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(t.created_at).toLocaleString()}</td>
      <td>${fromCoin}</td>
      <td>${toCoin}</td>
      <td>${t.amount}</td>
      <td>${converted}</td>
    `;
    tbody.appendChild(tr);
  });
}
</script>
</body>
</html>
