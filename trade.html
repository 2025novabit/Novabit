<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Trade</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{font-family:Arial;background:#f4f6fa;padding:20px}
.card{background:#fff;padding:15px;margin-bottom:15px;border-radius:8px}
select,input,button{width:100%;padding:10px;margin-top:8px}
button{background:#4b49ac;color:#fff;border:none}
</style>
</head>
<body>

<h2>Spot Trade (Convert)</h2>

<div class="card">
  <label>From</label>
  <select id="fromCoin"></select>

  <label>To</label>
  <select id="toCoin"></select>

  <label>Amount</label>
  <input id="amount" type="number">

  <div>Rate: <span id="rate">-</span></div>

  <button onclick="convert()">Convert</button>
</div>

<h2>Wallet</h2>
<div class="card" id="walletBox"></div>

<script>
const supabase = supabasejs.createClient(
  "https://iecnioogmafgxwarmkxz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImllY25pb29nbWFmZ3h3YXJta3h6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3OTYwNDgsImV4cCI6MjA4MzM3MjA0OH0.3zkHQpwdYUVdf6_GkPfkLRu7xgWMaUHNuFmYMBgBsJA"
);

let user, wallet={}, prices={};

(async()=>{
  user = (await supabase.auth.getUser()).data.user;
  if(!user){ alert("Login"); return; }
  await loadWallet();
})();

async function loadWallet(){
  const { data } = await supabase
    .from('wallets')
    .select('coin_symbol,balance')
    .eq('user_id', user.id);

  wallet={};
  let html='';
  fromCoin.innerHTML='';
  toCoin.innerHTML='';

  data.forEach(w=>{
    wallet[w.coin_symbol]=Number(w.balance);
    html+=`${w.coin_symbol}: ${w.balance}<br>`;
    fromCoin.innerHTML+=`<option>${w.coin_symbol}</option>`;
    toCoin.innerHTML+=`<option>${w.coin_symbol}</option>`;
  });

  walletBox.innerHTML=html;
  fromCoin.onchange=toCoin.onchange=updateRate;
  updateRate();
}

async function updateRate(){
  const f=fromCoin.value, t=toCoin.value;
  if(f===t){ rate.innerText='1'; return; }

  const r=await fetch(
    `https://api.coingecko.com/api/v3/simple/price?ids=${f.toLowerCase()},${t.toLowerCase()}&vs_currencies=usd`
  ).then(r=>r.json());

  const rf=r[f.toLowerCase()].usd;
  const rt=r[t.toLowerCase()].usd;
  prices[f]=rf; prices[t]=rt;
  rate.innerText=(rf/rt).toFixed(6);
}

async function convert(){
  const f=fromCoin.value, t=toCoin.value;
  const amt=Number(amount.value);
  if(amt<=0 || wallet[f]<amt) return alert("Invalid");

  const receive = amt * (prices[f]/prices[t]);

  await supabase.from('wallets')
    .update({ balance: wallet[f]-amt })
    .eq('user_id', user.id).eq('coin_symbol', f);

  await supabase.from('wallets')
    .update({ balance: (wallet[t]||0)+receive })
    .eq('user_id', user.id).eq('coin_symbol', t);

  await supabase.from('trade_history').insert({
    user_id:user.id,
    type:'spot',
    side:'buy',
    from_symbol:f,
    to_symbol:t,
    amount:amt,
    price:prices[f]
  });

  amount.value='';
  await loadWallet();
  alert("Converted");
}
</script>
</body>
</html>
