<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Trade | Spot</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
<style>
body { font-family:'Roboto',sans-serif; margin:0; background:#f8f9fa; padding-bottom:60px; }
header { background:#1a1a2e; color:#fff; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:10; }
header h1 { margin:0; font-size:20px; }
#menuBtn { background:#4b49ac; color:#fff; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:500; }
#sideMenu { position:fixed; top:0; right:-400px; width:33%; max-width:300px; height:100%; background:#fff; box-shadow:-2px 0 6px rgba(0,0,0,0.2); transition:right .3s; z-index:100; padding:20px; overflow-y:auto; }
#sideMenu.active { right:0; }
#sideMenu h2 { margin-top:0; }
#sideMenu a { display:block; margin:15px 0; color:#1a1a2e; text-decoration:none; font-weight:500; }
#closeMenu { background:#e74c3c; color:#fff; border:none; padding:8px 12px; cursor:pointer; border-radius:5px; margin-bottom:15px; }
.container{ padding:20px; }
.card { background:#fff; padding:25px; border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,0.1); margin-bottom:20px; }
.card h2 { margin-top:0; }
.input-group { margin-bottom:15px; }
.input-group label { display:block; margin-bottom:5px; font-weight:500; }
.input-group select, .input-group input { width:100%; padding:10px; border:1px solid #ccc; border-radius:5px; }
button { padding:10px 20px; margin-right:10px; background:#4b49ac; color:#fff; border:none; border-radius:5px; cursor:pointer; font-weight:500; }
button:hover { background:#3a3690; }
#walletBalances ul{ padding-left:20px; }
.table-container { max-height:200px; overflow-y:auto; margin-top:20px; }
table { width:100%; border-collapse:collapse; }
th,td { padding:10px; text-align:left; }
th { background:#1a1a2e; color:#fff; position:sticky; top:0; }
tr:nth-child(even){ background:#f1f1f1; }
.bottom-nav { position:fixed; bottom:0; width:100%; background:#1a1a2e; display:flex; justify-content:space-around; padding:10px 0; z-index:10; }
.bottom-nav a { color:#fff; text-decoration:none; font-size:14px; display:flex; flex-direction:column; align-items:center; }
.bottom-nav a.active { color:#4b49ac; }
@media(min-width:768px){ .bottom-nav{ display:none; } }
</style>
</head>
<body>

<header>
  <h1>Spot Trade</h1>
  <button id="menuBtn" onclick="toggleMenu()">Menu</button>
</header>

<div id="sideMenu">
  <button id="closeMenu" onclick="toggleMenu()">Close</button>
  <h2>Menu</h2>
  <a href="profile.html">Profile</a>
  <a href="wallet.html">Wallet</a>
  <a href="trade.html" class="active">Trade</a>
</div>

<div class="container">

  <!-- Wallet Balances -->
  <div class="card">
    <h2>Wallet Balances</h2>
    <div id="walletBalances">Loading...</div>
  </div>

  <!-- Trade Form -->
  <div class="card">
    <h2>Trade</h2>
    <div class="input-group">
      <label for="fromCoin">From Coin</label>
      <select id="fromCoin"></select>
    </div>
    <div class="input-group">
      <label for="toCoin">To Coin</label>
      <select id="toCoin"></select>
    </div>
    <div class="input-group">
      <label>Price (USD)</label>
      <div id="currentPrice">-</div>
    </div>
    <div class="input-group">
      <label>Amount</label>
      <input type="number" id="amount" placeholder="0.0000">
    </div>
    <button onclick="executeTrade()">Trade</button>
  </div>

  <!-- Trade History -->
  <div class="card">
    <h2>Trade History</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr><th>Date</th><th>From</th><th>To</th><th>Amount</th><th>Price</th></tr>
        </thead>
        <tbody id="tradeHistory">
          <tr><td colspan="5">No trades yet</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

<div class="bottom-nav">
  <a href="index.html">Home</a>
  <a href="wallet.html">Wallet</a>
  <a href="market.html">Markets</a>
  <a href="trade.html" class="active">Trade</a>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = "https://iecnioogmafgxwarmkxz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImllY25pb29nbWFmZ3h3YXJta3h6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3OTYwNDgsImV4cCI6MjA4MzM3MjA0OH0.3zkHQpwdYUVdf6_GkPfkLRu7xgWMaUHNuFmYMBgBsJA";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let walletBalances = {};
let allCoins = [];
let currentPrice = 0;

function toggleMenu(){ document.getElementById('sideMenu').classList.toggle('active'); }

function renderWallet(){
  let html = '<ul>';
  for(let coin in walletBalances){
    if(walletBalances[coin]>0) html += `<li>${coin}: ${walletBalances[coin]}</li>`;
  }
  if(html==='<ul>') html += '<li>No balances</li>';
  html += '</ul>';
  document.getElementById('walletBalances').innerHTML = html;
}

// Populate coin selects
function populateCoinSelects(){
  const fromSelect = document.getElementById('fromCoin');
  const toSelect = document.getElementById('toCoin');
  fromSelect.innerHTML = '';
  toSelect.innerHTML = '';
  allCoins.forEach(c => {
    if(walletBalances[c.symbol]>0){
      fromSelect.innerHTML += `<option value="${c.symbol}">${c.symbol}</option>`;
    }
    toSelect.innerHTML += `<option value="${c.symbol}">${c.symbol}</option>`;
  });
  updatePrice();
}

// Update price
async function updatePrice(){
  const from = document.getElementById('fromCoin').value;
  const to = document.getElementById('toCoin').value;
  if(!from || !to) return;
  const fromCoin = allCoins.find(c=>c.symbol===from);
  const toCoin = allCoins.find(c=>c.symbol===to);
  if(!fromCoin || !toCoin) return;

  try{
    const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${fromCoin.coingecko_id},${toCoin.coingecko_id}&vs_currencies=usd`);
    const data = await res.json();
    const fromPrice = data[fromCoin.coingecko_id].usd;
    const toPrice = data[toCoin.coingecko_id].usd;
    currentPrice = fromPrice / toPrice;
    document.getElementById('currentPrice').innerText = `$1 ${from} = ${currentPrice.toFixed(6)} ${to}`;
  }catch(e){ console.log(e); }
}

// Execute trade
async function executeTrade(){
  const from = document.getElementById('fromCoin').value;
  const to = document.getElementById('toCoin').value;
  const amt = parseFloat(document.getElementById('amount').value);
  const userId = localStorage.getItem('user_id');
  if(!userId){ alert('Login required'); return; }
  if(!from || !to || !amt || amt<=0){ alert('Invalid input'); return; }
  if(!walletBalances[from] || walletBalances[from]<amt){ alert('Insufficient balance'); return; }

  const toAmt = amt * currentPrice;

  walletBalances[from]-=amt;
  walletBalances[to] = (walletBalances[to]||0)+toAmt;

  // Update wallets table
  await supabase.from('wallets').upsert([
    {user_id:userId, coin_symbol:from, balance:walletBalances[from]},
    {user_id:userId, coin_symbol:to, balance:walletBalances[to]}
  ], {onConflict:['user_id','coin_symbol']});

  // Insert trade history
  await supabase.from('trade_history').insert([{
    user_id:userId,
    from_coin:from,
    to_coin:to,
    amount:amt,
    price:currentPrice,
    created_at:new Date()
  }]);

  renderWallet();
  alert(`Traded ${amt} ${from} â†’ ${toAmt.toFixed(6)} ${to}`);
  updatePrice();
  populateCoinSelects();
}

// Update price when selects change
document.getElementById('fromCoin').addEventListener('change', updatePrice);
document.getElementById('toCoin').addEventListener('change', updatePrice);

// Init page
async function init(){
  const userId = localStorage.getItem('user_id');
  if(!userId){ alert('Login required'); window.location.href='login.html'; return; }

  // Load coins
  const { data: coins } = await supabase.from('coins').select('*').eq('is_active', true);
  allCoins = coins;

  // Load wallets
  const { data: wallets } = await supabase.from('wallets').select('*').eq('user_id', userId);
  wallets.forEach(w => walletBalances[w.coin_symbol]=parseFloat(w.balance));

  renderWallet();
  populateCoinSelects();
}

window.onload = init;
</script>

</body>
</html>
