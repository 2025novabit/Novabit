<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Trade | Novabit</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f5f6fa}
header{background:#1a1a2e;color:#fff;padding:15px;display:flex;justify-content:space-between}
.tabs{display:flex}
.tabs button{flex:1;padding:12px;border:none;cursor:pointer;font-weight:bold}
.tabs button.active{background:#4b49ac;color:#fff}
.card{background:#fff;margin:15px;padding:15px;border-radius:8px}
select,input,button{width:100%;padding:10px;margin:6px 0}
button{background:#4b49ac;color:#fff;border:none;border-radius:5px}
#chart{height:300px}
</style>
</head>

<body>

<header>
  <b>Trade</b>
</header>

<div class="tabs">
  <button id="spotTab" class="active" onclick="setMode('spot')">Spot Trade</button>
  <button id="futuresTab" onclick="setMode('futures')">Futures Trade</button>
</div>

<div class="card">
  <b>Wallet</b>
  <div id="walletBox">Loading...</div>
</div>

<div class="card">
  <b>Select Coin</b>
  <select id="coinSelect"></select>
  <div>Price: <span id="price">-</span> USD</div>
</div>

<div class="card">
  <b>Trade</b>
  <input type="number" id="amount" placeholder="Amount">
  <button onclick="buy()">Buy</button>
  <button onclick="sell()">Sell</button>
</div>

<div class="card">
  <b>Chart</b>
  <div id="chart"></div>
</div>

<div class="card">
  <b>Trade History</b>
  <ul id="history"></ul>
</div>

<script>
/* ================== CONFIG ================== */
const supabase = window.supabase.createClient(
  "https://iecnioogmafgxwarmkxz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImllY25pb29nbWFmZ3h3YXJta3h6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3OTYwNDgsImV4cCI6MjA4MzM3MjA0OH0.3zkHQpwdYUVdf6_GkPfkLRu7xgWMaUHNuFmYMBgBsJA"
);

let MODE = 'spot';
let prices = {};
let coins = [];
let wallet = {};

/* ================== AUTH ================== */
const { data:{ user } } = await supabase.auth.getUser();
if(!user){ location.href='login.html'; }

/* ================== MODE ================== */
function setMode(m){
  MODE = m;
  document.getElementById('spotTab').classList.toggle('active',m==='spot');
  document.getElementById('futuresTab').classList.toggle('active',m==='futures');
}

/* ================== LOAD COINS ================== */
async function loadCoins(){
  const { data } = await supabase.from('coins')
    .select('symbol,coingecko_id')
    .eq('is_active',true);

  coins = data;
  const sel = document.getElementById('coinSelect');
  sel.innerHTML='';
  data.forEach(c=>{
    sel.innerHTML += `<option value="${c.symbol}" data-id="${c.coingecko_id}">${c.symbol}</option>`;
  });
  updatePrice();
}

/* ================== PRICE ================== */
async function updatePrice(){
  const opt = coinSelect.options[coinSelect.selectedIndex];
  const id = opt.dataset.id;
  const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=usd`);
  const p = (await res.json())[id].usd;
  prices[opt.value]=p;
  document.getElementById('price').innerText = p;
  updateChart(id);
}

/* ================== WALLET ================== */
async function loadWallet(){
  const { data } = await supabase
    .from('wallets')
    .select('coin_symbol,balance,locked')
    .eq('user_id',user.id);

  wallet = {};
  let html='';
  data.forEach(w=>{
    wallet[w.coin_symbol]=w;
    html+=`${w.coin_symbol}: ${w.balance} (locked ${w.locked})<br>`;
  });
  document.getElementById('walletBox').innerHTML=html;
}

/* ================== SPOT ================== */
async function buy(){
  const coin = coinSelect.value;
  const amt = Number(amount.value);
  if(!amt) return alert('amount');

  if(MODE==='spot'){
    wallet[coin].balance += amt;
    await supabase.from('wallets')
      .update({ balance: wallet[coin].balance })
      .eq('user_id',user.id).eq('coin_symbol',coin);
  }

  addHistory('BUY',coin,amt);
}

/* ================== SELL ================== */
async function sell(){
  const coin = coinSelect.value;
  const amt = Number(amount.value);
  if(!amt) return alert('amount');

  if(MODE==='spot'){
    if(wallet[coin].balance < amt) return alert('balance');
    wallet[coin].balance -= amt;
    await supabase.from('wallets')
      .update({ balance: wallet[coin].balance })
      .eq('user_id',user.id).eq('coin_symbol',coin);
  }

  addHistory('SELL',coin,amt);
}

/* ================== HISTORY ================== */
async function addHistory(type,coin,amt){
  await supabase.from('trade_history').insert({
    user_id:user.id,
    trade_type:type,
    coin_symbol:coin,
    amount:amt,
    price:prices[coin]
  });
  loadHistory();
}

async function loadHistory(){
  const { data } = await supabase.from('trade_history')
    .select('*').eq('user_id',user.id).order('created_at',{ascending:false}).limit(20);
  const ul = document.getElementById('history');
  ul.innerHTML='';
  data.forEach(t=>{
    ul.innerHTML+=`<li>${t.trade_type} ${t.amount} ${t.coin_symbol} @ ${t.price}</li>`;
  });
}

/* ================== CHART ================== */
let chart = LightweightCharts.createChart(document.getElementById('chart'),{height:300});
let series = chart.addLineSeries();

async function updateChart(id){
  const res = await fetch(`https://api.coingecko.com/api/v3/coins/${id}/market_chart?vs_currency=usd&days=1`);
  const d = await res.json();
  series.setData(d.prices.map(p=>({time:p[0]/1000,value:p[1]})));
}

/* ================== INIT ================== */
coinSelect.onchange=updatePrice;
await loadCoins();
await loadWallet();
await loadHistory();
</script>

</body>
</html>
