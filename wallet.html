<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Wallet | Novabit</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial,Roboto,sans-serif;background:#f8f9fa;padding-bottom:70px;}
header{background:#1a1a2e;color:#fff;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10;}
header h1{margin:0;font-size:20px;}
#menuBtn{background:#4b49ac;color:#fff;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;}
#sideMenu{position:fixed;top:0;right:-400px;width:33%;height:100%;background:#fff;box-shadow:-2px 0 6px rgba(0,0,0,.2);transition:right 0.3s;padding:20px;z-index:100;}
#sideMenu.active{right:0;}
#sideMenu h2{margin-top:0;}
#sideMenu a{display:block;margin:15px 0;color:#1a1a2e;text-decoration:none;font-weight:500;}
#closeMenu{background:#e74c3c;color:#fff;border:none;padding:8px 12px;border-radius:5px;cursor:pointer;margin-bottom:15px;}

.container{padding:20px;}
.card{background:#fff;padding:25px;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,.1);margin-bottom:20px;}
.card h2{margin-top:0;}
.total-balance{font-size:32px;font-weight:bold;margin:10px 0 20px;}
button{padding:10px 20px;margin-right:10px;background:#4b49ac;color:#fff;border:none;border-radius:5px;cursor:pointer;font-weight:500;}
button:disabled{background:#999;cursor:not-allowed;}
.table-container{max-height:400px;overflow:auto;margin-top:10px;}
table{width:100%;border-collapse:collapse;}
th,td{padding:10px;font-size:14px;text-align:left;}
th{background:#1a1a2e;color:#fff;position:sticky;top:0;}
tr:nth-child(even){background:#f1f1f1;}
.bottom-nav{position:fixed;bottom:0;width:100%;background:#1a1a2e;display:flex;justify-content:space-around;padding:10px 0;z-index:20;}
.bottom-nav a{color:#fff;text-decoration:none;font-size:14px;display:flex;flex-direction:column;align-items:center;}
.bottom-nav a.active{color:#4b49ac;}
</style>
</head>
<body>

<header>
  <h1>Wallet</h1>
  <button id="menuBtn" onclick="toggleMenu()">Menu</button>
</header>

<div id="sideMenu">
  <button id="closeMenu" onclick="toggleMenu()">Close</button>
  <h2>Menu</h2>
  <a href="profile.html">Profile</a>
  <a href="kyc.html">KYC</a>
  <a href="changepassword.html">Change Password</a>
  <a href="2fa.html">2FA Settings</a>
  <a href="fee.html">Fee</a>
  <a href="referral.html">Referral</a>
</div>

<div class="container">

<!-- TOTAL BALANCE -->
<div class="card">
  <h2>Total Balance</h2>
  <div class="total-balance" id="totalBalance">$0.00</div>
  <button onclick="window.location.href='deposit.html'">Deposit</button>
  <button onclick="window.location.href='withdraw.html'">Withdraw</button>
  <div id="withdrawNote" style="margin-top:10px;color:#e74c3c;font-weight:500;"></div>
</div>

<!-- ASSETS -->
<div class="card">
  <h2>Assets (Top 100)</h2>
  <div class="table-container">
    <table id="walletTable">
      <thead>
        <tr>
          <th>Coin</th>
          <th>Price (USD)</th>
          <th>Balance</th>
          <th>Value (USD)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

</div>

<div class="bottom-nav">
  <a href="dashboard.html">Dashboard</a>
  <a href="wallet.html" class="active">Wallet</a>
  <a href="market.html">Market</a>
  <a href="trade.html">Trade</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL = "https://iecnioogmafgxwarmkxz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImllY25pb29nbWFmZ3h3YXJta3h6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3OTYwNDgsImV4cCI6MjA4MzM3MjA0OH0.3zkHQpwdYUVdf6_GkPfkLRu7xgWMaUHNuFmYMBgBsJA";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

function toggleMenu() {
  document.getElementById('sideMenu').classList.toggle('active');
}

async function loadWallet() {
  const { data: auth } = await supabaseClient.auth.getUser();
  if (!auth.user) {
    window.location.href = "login.html";
    return;
  }

  const { data: wallets, error } = await supabaseClient
    .from('wallets')
    .select('asset,balance')
    .eq('user_id', auth.user.id);

  if (error) {
    console.error(error);
    const tbody = document.querySelector('#walletTable tbody');
    tbody.innerHTML = '<tr><td colspan="4">Failed to load wallet data</td></tr>';
    return;
  }

  const tbody = document.querySelector('#walletTable tbody');
  tbody.innerHTML = '';

  // گرفتن قیمت‌ها
  const ids = wallets.map(w => w.asset.toLowerCase()).join(',');
  let prices = {};
  if (ids) {
    prices = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd`)
      .then(r => r.json())
      .catch(() => ({}));
  }

  let total = 0;

  wallets.forEach(w => {
    const price = prices[w.asset.toLowerCase()]?.usd || 0;
    const value = price * Number(w.balance);
    total += value;

    // فقط تغییر: اگر قیمت > 1 دلار دو رقم اعشار شود
    const displayPrice = price > 1 ? price.toFixed(2) : price;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${w.asset}</td>
      <td>$${displayPrice}</td>
      <td>${Number(w.balance).toFixed(6)}</td>
      <td>$${value.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('totalBalance').innerText = `$${total.toFixed(2)}`;
}

document.addEventListener('DOMContentLoaded', loadWallet);
</script>

</body>
</html>
