<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Deposit Approval</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
<style>
body {font-family:'Roboto',sans-serif;margin:0;background:#f8f9fa;padding:20px;}
h2 {text-align:center;margin-bottom:20px;}
table {width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden;}
th, td {padding:12px;text-align:left;border-bottom:1px solid #ddd;}
th {background:#4b49ac;color:#fff;}
tr:hover {background:#f1f1f1;}
button {padding:6px 12px;border:none;border-radius:4px;cursor:pointer;}
button.approve {background:#28a745;color:#fff;}
button.reject {background:#dc3545;color:#fff;}
input[type="number"] {width:80px;padding:4px;border-radius:4px;border:1px solid #ccc;}
.back {margin-bottom:20px;background:#e74c3c;color:#fff;}
</style>
</head>
<body>

<button class="back" onclick="history.back()">Back</button>
<h2>Deposit Requests Approval</h2>
<table>
  <thead>
    <tr>
      <th>User ID</th>
      <th>Asset</th>
      <th>Network</th>
      <th>Amount</th>
      <th>Status</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="requestTable"></tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://iecnioogmafgxwarmkxz.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjcWJ3dnV4ZmNzZ3hneHJvbHN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MjEyNzQsImV4cCI6MjA4MzE5NzI3NH0.vZvxVRYnQHi8V2mm9RYdj-eApog62jSBrl1ahvkjyRQ';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

async function loadRequests() {
  const { data, error } = await supabase
    .from('deposit_requests') // نام جدول دقیق
    .select('id,user_id,asset,network,amount,status')
    .order('created_at', { ascending: false });

  if(error) {
    console.error('Failed to load requests:', error);
    document.getElementById('requestTable').innerHTML = '<tr><td colspan="6">Failed to load requests</td></tr>';
    return;
  }

  const tbody = document.getElementById('requestTable');
  tbody.innerHTML = '';

  data.forEach(req => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${req.user_id}</td>
      <td>${req.asset}</td>
      <td>${req.network}</td>
      <td><input type="number" value="${req.amount}" min="0" step="0.00000001" id="amt_${req.id}"></td>
      <td>${req.status}</td>
      <td>
        <button class="approve" onclick="handleRequest('${req.id}', true)">Approve</button>
        <button class="reject" onclick="handleRequest('${req.id}', false)">Reject</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function handleRequest(requestId, approve) {
  const amountInput = document.getElementById('amt_' + requestId);
  const newAmount = parseFloat(amountInput.value);

  if(approve) {
    // دریافت اطلاعات درخواست
    const { data: reqData, error: reqErr } = await supabase
      .from('deposit_requests')
      .select('*')
      .eq('id', requestId)
      .single();
    if(reqErr) return console.error(reqErr);

    // بروزرسانی موجودی کیف پول
    const { error: walletErr } = await supabase
      .from('wallets')
      .update({ balance: supabase.raw('balance + ?', [newAmount]) })
      .eq('user_id', reqData.user_id)
      .eq('coin_symbol', reqData.asset);
    if(walletErr) return console.error(walletErr);
  }

  // بروزرسانی وضعیت درخواست
  const { error: statusErr } = await supabase
    .from('deposit_requests')
    .update({ status: approve ? 'approved' : 'rejected', amount: newAmount })
    .eq('id', requestId);
  if(statusErr) return console.error(statusErr);

  loadRequests();
}

// بررسی لاگین ادمین
supabase.auth.getUser().then(({ data })=>{
  if(!data.user) window.location.href = '/login.html';
  else loadRequests();
});
</script>
</body>
</html>
