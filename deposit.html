<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Deposit | Novabit</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">

<style>
body{font-family:'Roboto',sans-serif;margin:0;background:#f8f9fa}
header{background:#1a1a2e;color:#fff;padding:15px;text-align:center;font-size:18px; display:flex; justify-content:space-between; align-items:center;}
.container{padding:20px}

/* Coin scroll vertical */
.coin-scroll{display:flex;flex-direction:column;overflow-y:auto;gap:10px;max-height:70vh;padding:10px 0}
.coin-card{
  background:#fff;border:1px solid #ccc;border-radius:10px;
  padding:10px;width:100%;
  cursor:pointer; display:flex; align-items:center; gap:10px;
}
.coin-card:hover{border-color:#4b49ac}
.coin-card img{width:40px;height:40px}

/* ‚úÖ ŸÅŸÇÿ∑ ÿ∏ÿßŸáÿ± ÿ®ÿßŸÑÿßŸÜÿ≥ (Ÿà€åÿ±ÿß€åÿ¥) */
.balance{
  font-size:13px;
  color:#4b49ac;
  font-weight:600;
}

/* Deposit panel Ÿàÿ≥ÿ∑ ÿµŸÅÿ≠Ÿá */
.panel{
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%);
  width:360px;
  max-height:80%;
  overflow-y:auto;
  background:#fff;
  box-shadow:0 0 15px rgba(0,0,0,.3);
  padding:20px;
  z-index:100;
  display:none;
}
.panel.active{display:block}

.close,.back{background:#e74c3c;color:#fff;border:none;padding:6px 10px;border-radius:5px;cursor:pointer}

.address{
  background:#f1f1f1;
  padding:10px;
  border-radius:5px;
  font-family:monospace;
  margin-top:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.notice{margin-top:20px;font-size:14px;color:#555}
button.main{margin-top:15px;background:#4b49ac;color:#fff;border:none;padding:10px 15px;border-radius:5px;cursor:pointer}

/* ‚úÖ ŸÅŸÇÿ∑ ÿ∏ÿßŸáÿ± ÿ™ÿ∫€å€åÿ± ÿ¥ÿ®⁄©Ÿá (Ÿà€åÿ±ÿß€åÿ¥) */
select.network{
  width:100%;
  padding:10px;
  margin-top:10px;
  border-radius:8px;
  border:1px solid #4b49ac;
  font-weight:600;
}
</style>
</head>

<body>

<header>
  <button class="back" onclick="history.back()">Back</button>
  Deposit
</header>

<div class="container">
  <h3>Select Coin (Top 100)</h3>
  <div class="coin-scroll" id="coinScroll">
    <div>Loading coins...</div>
  </div>
</div>

<!-- Deposit Panel -->
<div class="panel" id="panel">
  <button class="close" onclick="closePanel()">Close</button>
  <h3 id="panelTitle"></h3>

  <label for="networkSelect">Network:</label>
  <select id="networkSelect" class="network"></select>

  <div class="address" id="depositAddress">
    <span>‚Äî</span>
    <button onclick="copyAddress()" style="background:#4b49ac;color:#fff;border:none;padding:5px 8px;border-radius:4px;cursor:pointer">Copy</button>
  </div>

  <div class="notice">
    After completing your deposit, please submit your deposit request.
  </div>

  <button class="main" onclick="goToRequest()">Submit Deposit Request</button>
</div>

<script>
const coinScroll = document.getElementById('coinScroll');
const panel = document.getElementById('panel');
const panelTitle = document.getElementById('panelTitle');
const depositAddress = document.getElementById('depositAddress');
const networkSelect = document.getElementById('networkSelect');

const SUPABASE_URL = 'https://iecnioogmafgxwarmkxz.supabase.co';
const SUPABASE_KEY = 'YOUR_REAL_KEY_HERE';

/* ‚úÖ ŸÅŸÇÿ∑ ÿß€åŸÜ ÿ®ÿÆÿ¥ ÿßÿ∂ÿßŸÅŸá ÿ¥ÿØŸá ‚Äì ÿ®ÿØŸàŸÜ ÿØÿ≥ÿ™ ÿ≤ÿØŸÜ ÿ®Ÿá ÿ¢ÿØÿ±ÿ≥ */
async function fetchBalances(){
  try{
    const res = await fetch(`${SUPABASE_URL}/rest/v1/wallets`,{
      headers:{
        'apikey':SUPABASE_KEY,
        'Authorization':'Bearer '+SUPABASE_KEY
      }
    });
    const data = await res.json();
    const balances = {};
    data.forEach(w=>{
      balances[w.asset]=w.balance;
    });
    return balances;
  }catch{
    return {};
  }
}

async function loadCoins(){
  const balances = await fetchBalances();

  try{
    const res = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1');
    const data = await res.json();

    coinScroll.innerHTML='';
    data.forEach(coin=>{
      const symbol = coin.symbol.toUpperCase();
      const balance = balances[symbol] || 0;

      const div = document.createElement('div');
      div.className='coin-card';
      div.innerHTML=`
        <img src="${coin.image}">
        <div>
          <b>${symbol}</b>
          <div class="balance">Balance: ${balance}</div>
        </div>
      `;
      div.onclick=()=>openPanel(symbol);
      coinScroll.appendChild(div);
    });
  }catch{
    coinScroll.innerHTML='Failed to load coins';
  }
}

/* üîí ⁄©ÿØ ÿ¢ÿØÿ±ÿ≥ Ÿàÿßÿ±€åÿ≤ = ÿØŸÇ€åŸÇÿßŸã ŸÖÿ´ŸÑ ÿÆŸàÿØÿ™ */
function openPanel(symbol){
  panelTitle.innerText = symbol+' Deposit';
  networkSelect.innerHTML='';
  depositAddress.querySelector('span').innerText='Loading address...';

  fetch(`${SUPABASE_URL}/rest/v1/deposit_wallets?asset=eq.${symbol}&is_active=eq.true`,{
    headers:{
      'apikey':SUPABASE_KEY,
      'Authorization':'Bearer '+SUPABASE_KEY
    }
  })
  .then(res=>res.json())
  .then(data=>{
    if(data.length){
      data.forEach((w,i)=>{
        const o=document.createElement('option');
        o.value=w.network;
        o.innerText=w.network;
        networkSelect.appendChild(o);
        if(i===0) depositAddress.querySelector('span').innerText=w.address;
      });
      networkSelect.onchange=()=>{
        depositAddress.querySelector('span').innerText =
          data.find(d=>d.network===networkSelect.value).address;
      };
    }else{
      depositAddress.querySelector('span').innerText='No address available';
    }
  });

  panel.classList.add('active');
}

function closePanel(){panel.classList.remove('active')}
function goToRequest(){location.href='deposit-request.html'}
function copyAddress(){
  navigator.clipboard.writeText(depositAddress.querySelector('span').innerText);
}

loadCoins();
</script>

</body>
</html>
