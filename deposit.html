<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Deposit | Novabit</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="coins.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { margin:0; font-family:Roboto,Arial,sans-serif; background:#f5f6fa; }
header { background:#1a1a2e; color:#fff; padding:15px; text-align:center; position:sticky; top:0; }
.container { max-width:1000px; margin:20px auto; padding:0 20px; }
.back-btn { background:#4b49ac; color:#fff; border:none; padding:10px 15px; border-radius:5px; cursor:pointer; margin-bottom:15px; }
.coin-list { display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:15px; }
.coin { background:#fff; border-radius:10px; padding:15px; text-align:center; cursor:pointer; border:1px solid #ddd; }
.coin img { width:48px; height:48px; margin-bottom:8px; }
.balance { font-size:13px; color:#555; }

.deposit-panel {
  position:fixed; top:0; right:-420px; width:380px; height:100%;
  background:#fff; box-shadow:-2px 0 15px rgba(0,0,0,.2);
  padding:20px; transition:.3s; overflow-y:auto;
}
.deposit-panel.active { right:0; }
.address { background:#f1f1f1; padding:10px; border-radius:6px; word-break:break-all; margin:10px 0; }
button { background:#4b49ac; color:#fff; border:none; padding:10px; border-radius:5px; cursor:pointer; width:100%; }
</style>
</head>
<body>

<header>Deposit</header>

<div class="container">
  <button class="back-btn" onclick="history.back()">‚Üê Back</button>
  <div class="coin-list" id="coinList">Loading coins...</div>
</div>

<div class="deposit-panel" id="panel">
  <h3 id="coinTitle"></h3>
  <div id="balanceText"></div>

  <label>Network</label>
  <select id="network"></select>

  <div class="address" id="address"></div>

  <label>Amount</label>
  <input type="number" id="amount" placeholder="0.00">

  <label>TXID (optional)</label>
  <input type="text" id="txid">

  <p style="font-size:13px;color:#555">
    After sending funds, submit your deposit request.
  </p>

  <button onclick="submitDeposit()">Submit Deposit Request</button>
</div>

<script>
const supabase = supabase.createClient(
  "https://iecnioogmafgxwarmkxz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
);

let wallets={}, balances={}, currentAsset=null;

async function loadData(){
  const { data: w } = await supabase.from('deposit_wallets').select('*').eq('is_active',true);
  w.forEach(x=>{
    if(!wallets[x.asset]) wallets[x.asset]=[];
    wallets[x.asset].push(x);
  });

  const { data: b } = await supabase.from('wallets').select('*');
  b.forEach(x=>balances[x.asset]=x.amount);

  renderCoins();
}

function renderCoins(){
  const list=document.getElementById('coinList');
  list.innerHTML='';
  COINS.forEach(c=>{
    if(!wallets[c.symbol]) return;
    list.innerHTML+=`
      <div class="coin" onclick="openPanel('${c.symbol}')">
        <img src="${c.icon}">
        <div>${c.symbol}</div>
        <div class="balance">Balance: ${balances[c.symbol]||0}</div>
      </div>`;
  });
}

function openPanel(asset){
  currentAsset=asset;
  const p=document.getElementById('panel');
  document.getElementById('coinTitle').innerText=asset;
  document.getElementById('balanceText').innerText="Balance: "+(balances[asset]||0);

  const net=document.getElementById('network');
  net.innerHTML='';
  wallets[asset].forEach(w=>{
    net.innerHTML+=`<option value="${w.network}" data-address="${w.address}">${w.network}</option>`;
  });
  document.getElementById('address').innerText=wallets[asset][0].address;
  net.onchange=()=>document.getElementById('address').innerText=net.selectedOptions[0].dataset.address;

  p.classList.add('active');
}

async function submitDeposit(){
  const amt=document.getElementById('amount').value;
  if(!amt) return alert("Enter amount");

  const { error } = await supabase.from('deposit_requests').insert({
    asset: currentAsset,
    network: network.value,
    amount: amt,
    txid: document.getElementById('txid').value
  });

  if(error) alert(error.message);
  else {
    alert("Deposit request submitted");
    location.reload();
  }
}

loadData();
</script>
</body>
</html>
