<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Referral Dashboard</title>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = "https://iecnioogmafgxwarmkxz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImllY25pb29nbWFmZ3h3YXJta3h6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3OTYwNDgsImV4cCI6MjA4MzM3MjA0OH0.3zkHQpwdYUVdf6_GkPfkLRu7xgWMaUHNuFmYMBgBsJA";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

async function loadReferralData() {
  // کاربر جاری
  const { data: { user }, error: userErr } = await supabase.auth.getUser();
  if (userErr || !user) {
    document.getElementById('refLink').innerText = "You must be logged in.";
    document.getElementById('totalInvited').innerText = "0";
    document.getElementById('invitedList').innerHTML = "<li>Not logged in</li>";
    return;
  }

  // اطلاعات کاربر در جدول users
  const { data: meData, error: meErr } = await supabase
    .from('users')
    .select('referral_code')
    .eq('user_id', user.id)
    .single();

  if (meErr || !meData) {
    document.getElementById('refLink').innerText = "Error loading your referral code.";
    return;
  }

  const myReferralCode = meData.referral_code;
  const referralLink = `${location.origin}/signup.html?ref=${myReferralCode}`;
  const refLinkEl = document.getElementById('refLink');
  refLinkEl.innerText = referralLink;
  refLinkEl.href = referralLink;

  // دریافت کاربران دعوت شده
  const { data: invitedUsers, error: invitedErr } = await supabase
    .from('users')
    .select('first_name,last_name')
    .eq('referral_id', myReferralCode);

  if (invitedErr) {
    document.getElementById('invitedList').innerText = "Error loading invited users.";
    return;
  }

  document.getElementById('totalInvited').innerText = invitedUsers.length;

  const listEl = document.getElementById('invitedList');
  listEl.innerHTML = '';
  if (invitedUsers.length === 0) {
    listEl.innerHTML = '<li>No users invited yet.</li>';
  } else {
    invitedUsers.forEach(u => {
      const li = document.createElement('li');
      li.innerText = `${u.first_name || ''} ${u.last_name || ''}`;
      listEl.appendChild(li);
    });
  }
}

window.addEventListener('DOMContentLoaded', loadReferralData);
</script>

<style>
body{font-family:'Segoe UI',sans-serif;background:#f8f9fa;margin:0;padding:20px;}
.container{max-width:600px;margin:auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 5px 20px rgba(0,0,0,0.1);}
h2{text-align:center;color:#1a1a2e;}
#refLink{display:block;text-align:center;margin:15px 0;padding:10px;background:#4b49ac;color:#fff;text-decoration:none;border-radius:5px;}
ul{list-style:none;padding:0;}
ul li{background:#f0f0f0;margin:5px 0;padding:10px;border-radius:5px;}
.info-box{display:flex;justify-content:space-between;margin-bottom:15px;font-weight:bold;}
</style>
</head>
<body>
<div class="container">
  <h2>Referral Dashboard</h2>
  <div class="info-box">
    <span>Your referral link:</span>
    <a href="#" id="refLink" target="_blank"></a>
  </div>
  <div class="info-box">
    <span>Total invited users:</span>
    <span id="totalInvited">0</span>
  </div>

  <h3>Invited Users</h3>
  <ul id="invitedList">
    <li>Loading...</li>
  </ul>
</div>
</body>
</html>
