<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Referral | Novabit</title>

<!-- Supabase -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const SUPABASE_URL = "https://iecnioogmafgxwarmkxz.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImllY25pb29nbWFmZ3h3YXJta3h6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3OTYwNDgsImV4cCI6MjA4MzM3MjA0OH0.3zkHQpwdYUVdf6_GkPfkLRu7xgWMaUHNuFmYMBgBsJA";

  window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>

<style>
body { margin:0; font-family:Roboto,sans-serif; background:#f4f6fa; }
header{ background:#1a1a2e; color:#fff; padding:15px 20px; display:flex; justify-content:space-between; align-items:center;}
header button{background:#4b49ac; border:none; color:#fff; padding:8px 14px; border-radius:5px; cursor:pointer;}
#sidePanel{position:fixed; top:0; right:-400px; width:300px; height:100%; background:#fff; box-shadow:-3px 0 10px rgba(0,0,0,.2); padding:20px; overflow-y:auto; transition:right 0.3s; z-index:100;}
#sidePanel.active{right:0;}
#sidePanel h2{margin-top:0;}
#sidePanel a{display:block; margin:10px 0; color:#1a1a2e; text-decoration:none; font-weight:500;}
.container{padding:20px; max-width:600px; margin:40px auto; background:#fff; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1);}
.container h2{text-align:center; margin-bottom:20px;}
.form-group{margin-bottom:15px;}
.form-group label{display:block; margin-bottom:5px; font-weight:500;}
.form-group input{width:100%; padding:10px; border-radius:5px; border:1px solid #ccc;}
#refLink{width:100%; padding:10px; border-radius:5px; border:1px solid #ccc;}
.stats{display:flex; justify-content:space-between; margin-top:20px;}
.stats div{background:#f0f0f0; padding:15px; border-radius:8px; flex:1; margin:0 5px; text-align:center;}
button.copyBtn{background:#4b49ac; color:#fff; border:none; padding:8px 12px; border-radius:5px; cursor:pointer; margin-top:5px;}
</style>
</head>
<body>

<header>
  <h2>Referral Dashboard</h2>
  <button onclick="togglePanel()">Menu</button>
</header>

<div id="sidePanel">
  <button onclick="togglePanel()" style="background:#e74c3c;color:#fff;padding:8px 12px;border:none;border-radius:5px;cursor:pointer;margin-bottom:15px;">Close</button>
  <h2>Menu</h2>
  <a href="dashboard.html">Dashboard</a>
  <a href="profile.html">Profile</a>
  <a href="kyc.html">KYC</a>
  <a href="changepassword.html">Change Password</a>
  <a href="2fa.html">2FA Settings</a>
  <a href="fee.html">Fees</a>
  <a href="referral.html" class="active">Referral</a>
</div>

<div class="container">
  <h2>Your Referral</h2>
  <div class="form-group">
    <label>Referral Link</label>
    <input type="text" id="refLink" readonly>
    <button class="copyBtn" onclick="copyLink()">Copy Link</button>
  </div>

  <div class="stats">
    <div>
      <h3>Total Invited</h3>
      <p id="totalRef">0</p>
    </div>
    <div>
      <h3>KYC Verified</h3>
      <p id="kycDone">0</p>
    </div>
  </div>
</div>

<script type="module">
// Toggle side panel
function togglePanel(){document.getElementById('sidePanel').classList.toggle('active');}

// Copy referral link
function copyLink(){
  const link = document.getElementById('refLink').value;
  navigator.clipboard.writeText(link).then(()=>alert("Link copied!"));
}

// Load referral stats
const loadReferral = async () => {
  const { data: { user } } = await supabase.auth.getUser();
  if(!user) return;

  // گرفتن ردیف خود کاربر
  const { data: myReferral } = await supabase
    .from("referrals")
    .select("*")
    .eq("user_id", user.id)
    .single();

  if(!myReferral) return;

  document.getElementById("refLink").value = `${location.origin}/login.html?ref=${myReferral.referral_code}`;

  // تعداد کل کاربران دعوت شده
  const { data: invitedUsers } = await supabase
    .from("referrals")
    .select("invited_id")
    .eq("referrer_id", user.id)
    .not("invited_id", "is", null);
  document.getElementById("totalRef").innerText = invitedUsers.length;

  // تعداد کاربران KYC شده
  const invitedIds = invitedUsers.map(u => u.invited_id);
  if(invitedIds.length === 0){
    document.getElementById("kycDone").innerText = 0;
    return;
  }

  const { data: verified } = await supabase
    .from("kyc")
    .select("user_id")
    .eq("status", "approved")
    .in("user_id", invitedIds);

  document.getElementById("kycDone").innerText = verified.length;
};

loadReferral();
</script>

</body>
</html>
