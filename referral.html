<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Referral</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    "https://iecnioogmafgxwarmkxz.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImllY25pb29nbWFmZ3h3YXJta3h6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3OTYwNDgsImV4cCI6MjA4MzM3MjA0OH0.3zkHQpwdYUVdf6_GkPfkLRu7xgWMaUHNuFmYMBgBsJA"
  );

  window.supabase = supabase;
</script>

<style>
body{font-family:Segoe UI;background:#f8f9fa;margin:0;padding:30px}
.box{background:#fff;padding:25px;border-radius:12px;max-width:800px;margin:auto}
h2{margin-top:0}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{padding:10px;border-bottom:1px solid #ddd;text-align:left}
.status-approved{color:green;font-weight:bold}
.status-pending{color:orange;font-weight:bold}
.status-rejected{color:red;font-weight:bold}
</style>
</head>

<body>

<div class="box">
  <h2>Referral Program</h2>

  <p><strong>Your referral link:</strong></p>
  <input id="refLink" style="width:100%;padding:10px" readonly>

  <p style="margin-top:15px">
    <strong>Total invited:</strong>
    <span id="refCount">0</span>
  </p>

  <table>
    <thead>
      <tr>
        <th>Invited User</th>
        <th>KYC Status</th>
        <th>Joined</th>
      </tr>
    </thead>
    <tbody id="refTable"></tbody>
  </table>
</div>

<script type="module">
(async ()=>{
  const { data: { user } } = await supabase.auth.getUser();
  if(!user){
    location.href="login.html";
    return;
  }

  const userId = user.id;

  // 1️⃣ دریافت کد ریفرال خود کاربر
  const { data: myRef } = await supabase
    .from("referrals")
    .select("referral_code, referral_count")
    .eq("referrer_id", userId)
    .single();

  if(myRef){
    refLink.value = `${location.origin}/login.html?ref=${myRef.referral_code}`;
    refCount.innerText = myRef.referral_count ?? 0;
  }

  // 2️⃣ لیست کاربران دعوت‌شده + وضعیت KYC
  const { data: invited } = await supabase
    .from("referrals")
    .select(`
      invited_id,
      created_at,
      kyc_requests ( status )
    `)
    .eq("referral_code", myRef.referral_code)
    .not("invited_id","is",null);

  refTable.innerHTML="";

  invited?.forEach(r=>{
    const status = r.kyc_requests?.status || "pending";

    refTable.insertAdjacentHTML("beforeend",`
      <tr>
        <td>${r.invited_id.slice(0,8)}...</td>
        <td class="status-${status}">${status}</td>
        <td>${new Date(r.created_at).toLocaleDateString()}</td>
      </tr>
    `);
  });
})();
</script>

</body>
</html>
